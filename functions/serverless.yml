service: blogify
app: blogify
provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  memorySize: 256
  timeout: 30
  environment:
    STAGE: ${self:provider.stage}
    USERS_TABLE: ${self:service}-users-${self:provider.stage}
    POSTS_TABLE: ${self:service}-posts-${self:provider.stage}
    VIRUS_DETECTIONS_TABLE: ${self:service}-virus-detections-${self:provider.stage}
    MEDIA_BUCKET:
      Ref: MediaBucket
    USER_POOL_ID:
      Ref: CognitoUserPool
    USER_POOL_CLIENT_ID:
      Ref: CognitoUserPoolClient
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.USERS_TABLE}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.USERS_TABLE}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.POSTS_TABLE}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.POSTS_TABLE}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.VIRUS_DETECTIONS_TABLE}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.VIRUS_DETECTIONS_TABLE}/index/*
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListObjectsV2
          Resource:
            Fn::Join:
              - ""
              - - "arn:aws:s3:::"
                - Ref: MediaBucket
                - "/*"
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            Fn::Join:
              - ""
              - - "arn:aws:s3:::"
                - Ref: MediaBucket
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminGetUser
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
            - cognito-idp:GetUser
          Resource:
            - Fn::GetAtt: [CognitoUserPool, Arn]
  apiGateway:
    binaryMediaTypes:
      - multipart/form-data
      - image/*
      - video/*
    shouldStartNameWithService: true
    metrics: true

plugins:
  - serverless-offline
  - serverless-openapi-documentation

custom:
  cognitoUserPoolArn:
    Fn::GetAtt: [CognitoUserPool, Arn]

  documentation:
    version: "1.0.0"
    title: "Blogify API"
    description: "Headless blogging platform API for content creators, journalists, and businesses"
    models:
      - name: Error
        description: "Error response"
        contentType: "application/json"
        schema:
          type: object
          properties:
            error:
              type: string
              description: "Error message"

      - name: AuthRequest
        description: "Authentication request"
        contentType: "application/json"
        schema:
          type: object
          required:
            - email
            - password
          properties:
            email:
              type: string
              format: email
              description: "User email address"
            password:
              type: string
              format: password
              description: "User password (min 8 chars, uppercase, lowercase, number)"
            role:
              type: string
              enum: ["admin", "editor", "guest_author"]
              description: "User role (optional, defaults to guest_author)"

      - name: AuthResponse
        description: "Authentication response"
        contentType: "application/json"
        schema:
          type: object
          properties:
            accessToken:
              type: string
              description: "Cognito access token"
            refreshToken:
              type: string
              description: "Cognito refresh token"
            idToken:
              type: string
              description: "Cognito ID token (use this for Authorization header)"
            user:
              type: object
              properties:
                id:
                  type: string
                email:
                  type: string
                role:
                  type: string

      - name: User
        description: "User object"
        contentType: "application/json"
        schema:
          type: object
          properties:
            id:
              type: string
            email:
              type: string
            role:
              type: string
              enum: ["admin", "editor", "guest_author"]

      - name: BlogPost
        description: "Blog post"
        contentType: "application/json"
        schema:
          type: object
          properties:
            id:
              type: string
            title:
              type: string
            content:
              type: string
            authorId:
              type: string
            authorEmail:
              type: string
            published:
              type: boolean
            createdAt:
              type: number
            updatedAt:
              type: number
            tags:
              type: array
              items:
                type: string
            excerpt:
              type: string

      - name: CreatePostRequest
        description: "Create blog post request"
        contentType: "application/json"
        schema:
          type: object
          required:
            - title
            - content
          properties:
            title:
              type: string
              description: "Post title"
            content:
              type: string
              description: "Post content"
            published:
              type: boolean
              default: false
              description: "Whether the post is published"
            tags:
              type: array
              items:
                type: string
              description: "Post tags"
            excerpt:
              type: string
              description: "Post excerpt (auto-generated if not provided)"

      - name: UpdatePostRequest
        description: "Update blog post request"
        contentType: "application/json"
        schema:
          type: object
          properties:
            title:
              type: string
            content:
              type: string
            published:
              type: boolean
            tags:
              type: array
              items:
                type: string
            excerpt:
              type: string

      - name: PostListResponse
        description: "List of blog posts"
        contentType: "application/json"
        schema:
          type: object
          properties:
            posts:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  title:
                    type: string
                  content:
                    type: string
                  authorId:
                    type: string
                  authorEmail:
                    type: string
                  published:
                    type: boolean
                  createdAt:
                    type: number
                  updatedAt:
                    type: number
                  tags:
                    type: array
                    items:
                      type: string
                  excerpt:
                    type: string
            count:
              type: number
            hasMore:
              type: boolean
              description: "Whether there are more posts available"
            lastKey:
              type: string
              description: "Cursor for pagination (base64 encoded)"

      - name: MediaUploadRequest
        description: "Media upload request"
        contentType: "application/json"
        schema:
          type: object
          required:
            - fileName
            - contentType
          properties:
            fileName:
              type: string
              description: "Name of the file to upload"
            contentType:
              type: string
              description: "MIME type of the file (e.g., image/jpeg, video/mp4)"

      - name: MediaUploadResponse
        description: "Media upload response"
        contentType: "application/json"
        schema:
          type: object
          properties:
            uploadUrl:
              type: string
              description: "Presigned URL for uploading the file (PUT request)"
            mediaUrl:
              type: string
              description: "Presigned URL for downloading/accessing the file"
            key:
              type: string
              description: "S3 key for the uploaded file"
            expiresIn:
              type: number
              description: "URL expiration time in seconds"

      - name: MediaDownloadResponse
        description: "Media download response"
        contentType: "application/json"
        schema:
          type: object
          properties:
            downloadUrl:
              type: string
              description: "Presigned URL for downloading the file"
            expiresIn:
              type: number
              description: "URL expiration time in seconds"

functions:
  # Define authorizer once
  # Note: Cognito authorizer is automatically handled by API Gateway
  # Authentication
  register:
    handler: src/handlers/auth.register
    events:
      - http:
          path: /auth/register
          method: post
          cors: true

  login:
    handler: src/handlers/auth.login
    events:
      - http:
          path: /auth/login
          method: post
          cors: true

  # Blog Posts
  createPost:
    handler: src/handlers/posts.create
    events:
      - http:
          path: /posts
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn}

  getPost:
    handler: src/handlers/posts.get
    events:
      - http:
          path: /posts/{id}
          method: get
          cors: true

  listPosts:
    handler: src/handlers/posts.list
    events:
      - http:
          path: /posts
          method: get
          cors: true

  updatePost:
    handler: src/handlers/posts.update
    events:
      - http:
          path: /posts/{id}
          method: put
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn}

  deletePost:
    handler: src/handlers/posts.delete
    events:
      - http:
          path: /posts/{id}
          method: delete
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn}

  # Media Management
  uploadMedia:
    handler: src/handlers/media.upload
    events:
      - http:
          path: /media/upload
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn}

  getMedia:
    handler: src/handlers/media.get
    events:
      - http:
          path: /media/{key}
          method: get
          cors:
            origin: "*"
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  # Virus Scanning
  virusScan:
    handler: src/handlers/virusScan.scan
    timeout: 60
    memorySize: 512
    events:
      - s3:
          bucket:
            Ref: MediaBucket
          event: s3:ObjectCreated:*
          existing: true
          rules:
            - prefix: media/

  # Security Dashboard (Admin Only)
  getSecurityDashboard:
    handler: src/handlers/security.getDashboard
    events:
      - http:
          path: /security/dashboard
          method: get
          cors:
            origin: "*"
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn}

  getSecurityDetections:
    handler: src/handlers/security.getDetections
    events:
      - http:
          path: /security/detections
          method: get
          cors:
            origin: "*"
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn}

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    PostsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.POSTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: authorId
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: N
          - AttributeName: published
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: authorId-createdAt-index
            KeySchema:
              - AttributeName: authorId
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: published-createdAt-index
            KeySchema:
              - AttributeName: published
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    VirusDetectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.VIRUS_DETECTIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: detectedAt
            AttributeType: N
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: userId-detectedAt-index
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: detectedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    MediaBucket:
      Type: AWS::S3::Bucket
      Properties:
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - POST
                - DELETE
                - HEAD
              AllowedOrigins:
                - "*"
              ExposedHeaders:
                - ETag
                - x-amz-server-side-encryption
                - x-amz-request-id
                - x-amz-id-2
              MaxAge: 3000
        VersioningConfiguration:
          Status: Enabled
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-user-pool-${self:provider.stage}
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Schema:
          - Name: email
            Required: true
            Mutable: true
          - Name: role
            Required: false
            Mutable: true
            AttributeDataType: String
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: true
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-client-${self:provider.stage}
        UserPoolId:
          Ref: CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        PreventUserExistenceErrors: ENABLED

    # Gateway Responses for CORS support
    GatewayResponseAccessDenied:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        ResponseType: ACCESS_DENIED
        RestApiId:
          Ref: ApiGatewayRestApi
        ResponseTemplates:
          application/json: '{"message":"$context.error.message","error":"Forbidden"}'

    GatewayResponseUnauthorized:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        ResponseType: UNAUTHORIZED
        RestApiId:
          Ref: ApiGatewayRestApi
        ResponseTemplates:
          application/json: '{"message":"$context.error.message","error":"Unauthorized"}'

    GatewayResponseDefault4XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: ApiGatewayRestApi
        ResponseTemplates:
          application/json: '{"message":"$context.error.message","error":"Bad Request"}'

  Outputs:
    UserPoolId:
      Value:
        Ref: CognitoUserPool
      Export:
        Name: ${self:provider.stage}-UserPoolId

    UserPoolClientId:
      Value:
        Ref: CognitoUserPoolClient
      Export:
        Name: ${self:provider.stage}-UserPoolClientId

    MediaBucketName:
      Value:
        Ref: MediaBucket
      Export:
        Name: ${self:provider.stage}-MediaBucketName

    ApiGatewayRestApiId:
      Value:
        Ref: ApiGatewayRestApi
      Export:
        Name: ${self:provider.stage}-ApiGatewayRestApiId

    ApiGatewayRestApiRootResourceId:
      Value:
        Fn::GetAtt:
          - ApiGatewayRestApi
          - RootResourceId
      Export:
        Name: ${self:provider.stage}-ApiGatewayRestApiRootResourceId
